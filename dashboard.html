<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>M114 DASHBOARD - M FAISAL SADLI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0f1a; }
        .glass-card {
            background: rgba(22, 29, 49, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s ease;
        }
        .glass-card:hover { transform: scale(1.01); }
    </style>
</head>
<body class="text-slate-100 min-h-screen p-4 md:p-8">

<div class="max-w-[1600px] mx-auto w-full">
    <header class="mb-8 flex justify-between items-center bg-[#161d31] p-8 rounded-[2rem] border border-white/5 shadow-2xl">
        <div class="flex items-center gap-6">
            <a href="index.html" class="bg-white/5 hover:bg-white/10 p-4 rounded-xl border border-white/10 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h1 class="text-3xl font-black text-white italic tracking-tighter uppercase">üìä M114 MONITOR</h1>
                <p class="text-blue-400 font-bold text-[10px] uppercase tracking-[0.3em]">Wide Horizon Dashboard</p>
            </div>
        </div>
        <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all">
            üîÑ Refresh
        </button>
    </header>

    <div id="dashboard-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16"></div>
</div>

<footer class="max-w-[1600px] mx-auto w-full pb-10">
    <div class="bg-[#161d31]/50 p-8 rounded-[2rem] border border-white/5 flex flex-col md:flex-row justify-between items-center gap-6">
        <div>
            <p class="text-white font-black italic text-lg uppercase">M FAISAL SADLI</p>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-1">Lead System Developer ‚Ä¢ v4.0 Stable</p>
        </div>
        <div class="flex items-center gap-4 text-xs font-bold text-green-400 uppercase">
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Live Sync Active
        </div>
    </div>
</footer>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1bHyJlzlZfrWSTrcH-ZAqKqzhz7vNVvILxvPQW9AMihQ/export?format=tsv&gid=0";

function toNum(val) {
    if (!val) return 0;
    let cleaned = val.toString().replace(/[^\d]/g, "");
    return parseInt(cleaned) || 0;
}

async function init() {
    try {
        const res = await fetch(SHEET_URL + "&t=" + new Date().getTime());
        const tsv = await res.text();
        const rows = tsv.split(/\r?\n/).map(row => row.split('\t').map(c => c.trim()));

        const cats = ["STORE", "ERO", "PROMOTOR", "FINANCING", "TECPROTEC", "INDOSAT", "TELKOMSEL", "DEVICE", "AKSESORIS", "TV"];
        let dataMap = {};
        let currentCat = "";

        rows.forEach(cols => {
            const cleanCols = cols.filter(c => c !== "");
            if (cleanCols.length === 0) return;
            const foundCat = cats.find(cat => cleanCols.some(cell => cell.toUpperCase() === cat));
            if (foundCat) { currentCat = foundCat; dataMap[currentCat] = []; return; }

            if (currentCat) {
                const name = cleanCols[0];
                const skip = ["NAMA", "TARGET", "VALUE", "QTY", "TOTAL", "ACHIEVEMENT"];
                if (!skip.some(s => name.toUpperCase() === s)) {
                    let value = (currentCat === "FINANCING") ? toNum(cleanCols[2]) : toNum(cleanCols[3]);
                    let target = toNum(cleanCols[1]);
                    let acv = (currentCat === "FINANCING") ? (cleanCols[4] || "0%") : (cleanCols[5] || "0%");
                    dataMap[currentCat].push({ name, value, target, acv });
                }
            }
        });

        const grid = document.getElementById('dashboard-grid');
        grid.innerHTML = "";
        Object.entries(dataMap).forEach(([title, items], idx) => {
            if (items.length > 0) {
                items.sort((a, b) => b.value - a.value); 
                renderCard(title, items, idx);
            }
        });
    } catch (e) { console.error(e); }
}

function renderCard(title, items, idx) {
    const isStore = title === "STORE";
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#a855f7', '#06b6d4'];
    const themeColor = colors[idx % colors.length];
    const id = `chart-${idx}`;
    
    const highPerson = items[0];
    const allSame = items.every(i => i.value === highPerson.value);
    const salesOnly = items.filter(i => i.value > 0);
    const lowPerson = salesOnly.length > 0 ? salesOnly[salesOnly.length - 1] : null;

    // Perhitungan Deviasi khusus Store
    const deviasiValue = highPerson.target - highPerson.value;
    const isLunas = deviasiValue <= 0;

    const chartHeight = Math.max(180, items.length * 30);
    const div = document.createElement('div');
    div.className = `glass-card p-6 rounded-[2rem] flex flex-col md:flex-row gap-6`;
    
    let bottomStatusHTML = "";
    if (isStore) {
        // TAMPILAN KHUSUS STORE: Menampilkan Deviasi
        bottomStatusHTML = `
            <p class="text-[9px] ${isLunas ? 'text-green-500' : 'text-red-500'} font-bold uppercase mb-1">Gap Deviation</p>
            <p class="text-xs font-black ${isLunas ? 'text-green-400' : 'text-red-400'}">
                ${isLunas ? 'üèÜ GOAL ACHIEVED!' : 'Rp -' + deviasiValue.toLocaleString('id-ID')}
            </p>
        `;
    } else if (allSame) {
        bottomStatusHTML = `<p class="text-[10px] text-amber-500 font-bold uppercase tracking-widest">‚öñÔ∏è Status: Balance</p>`;
    } else if (lowPerson) {
        bottomStatusHTML = `
            <p class="text-[9px] text-red-500 font-bold uppercase mb-1">‚ö†Ô∏è Performance Terendah</p>
            <p class="text-sm font-bold text-white truncate">${lowPerson.name}</p>
            <p class="text-sm font-black text-red-400 mt-0.5">Rp ${lowPerson.value.toLocaleString('id-ID')}</p>
        `;
    }

    div.innerHTML = `
        <div class="flex-[1.5] relative min-h-[200px]" style="height: ${chartHeight}px;">
            <canvas id="${id}"></canvas>
            ${isStore ? `
            <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                <span class="text-3xl font-black text-white leading-none">${highPerson.acv}</span>
                <span class="text-[10px] font-bold text-slate-500 uppercase mt-2">Achieved</span>
            </div>` : ''}
        </div>

        <div class="flex-1 flex flex-col justify-between border-l border-white/5 pl-6">
            <div>
                <h2 class="text-lg font-black text-white italic uppercase mb-4" style="border-left: 4px solid ${themeColor}; padding-left: 12px;">${title}</h2>
                
                <div class="bg-white/5 p-4 rounded-xl border border-white/5 mb-3">
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1">${isStore ? 'Current Value' : 'Peringkat 1'}</p>
                    <p class="text-sm font-bold text-white truncate">${isStore ? 'Store Total' : highPerson.name}</p>
                    <p class="text-sm font-black text-blue-400 mt-1">Rp ${highPerson.value.toLocaleString('id-ID')}</p>
                </div>

                <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                    ${bottomStatusHTML}
                </div>
            </div>
            <p class="text-[9px] font-black text-slate-600 uppercase mt-4 tracking-tighter italic italic">M114 Performance Engine</p>
        </div>
    `;

    document.getElementById('dashboard-grid').appendChild(div);
    const ctx = document.getElementById(id).getContext('2d');
    
    if (isStore) {
        const percentVal = parseInt(highPerson.acv) || 0;
        new Chart(ctx, {
            type: 'doughnut',
            data: { datasets: [{ data: [percentVal, percentVal >= 100 ? 0 : 100 - percentVal], backgroundColor: [themeColor, '#1e2741'], borderWidth: 0, borderRadius: 10 }] },
            options: { cutout: '80%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    } else {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: items.map(i => i.name),
                datasets: [{ 
                    data: items.map(i => i.value), 
                    backgroundColor: items.map(i => {
                        if (i.value === 0) return '#1f2937';
                        if (!allSame && lowPerson && i.name === lowPerson.name) return '#ef4444'; 
                        return themeColor;
                    }), 
                    borderRadius: 5,
                    barThickness: 15
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: (ctx) => ctx.raw === 0 ? " Belum ada jualan" : " Rp " + ctx.raw.toLocaleString('id-ID') }
                    }
                },
                scales: { 
                    x: { display: false }, 
                    y: { grid: { display: false }, border: { display: false }, ticks: { color: '#fff', font: { size: 9 } } } 
                }
            }
        });
    }
}

init();
</script>
</body>
</html>
