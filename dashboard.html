<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DASHBOARD M114 - OPTIMIZED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas { max-height: 400px; }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-900 to-red-900 min-h-screen text-white font-sans">

<header class="p-8 text-center">
    <h1 class="text-3xl font-bold tracking-widest text-white drop-shadow-lg">üìä DASHBOARD M114</h1>
    <p class="text-slate-300 text-sm mt-2">Update: Conditional Layout Rendering</p>
</header>

<main class="max-w-6xl mx-auto p-4 space-y-12 pb-20">
    <section id="STORE" class="bg-black/20 p-6 rounded-3xl backdrop-blur-sm border border-white/5"></section>
    <section id="ERO" class="bg-black/20 p-6 rounded-3xl backdrop-blur-sm border border-white/5"></section>
    <section id="PROMOTOR" class="bg-black/20 p-6 rounded-3xl backdrop-blur-sm border border-white/5"></section>
    <section id="FINANCING" class="bg-black/20 p-6 rounded-3xl backdrop-blur-sm border border-white/5"></section>

    <div class="text-center pt-8">
        <a href="index.html" class="inline-block px-8 py-3 bg-white text-slate-900 rounded-full font-bold hover:bg-slate-200 transition-all shadow-xl">
            ‚Üê Kembali ke Report
        </a>
    </div>
</main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1UMVGCANWjOQlwGFzi47POm7dVEtYOmAq4jz7O2rol5o/export?format=tsv";

/* ================= UTIL ================= */
function parseIDR(val) {
    if (!val) return null;
    const cleaned = val.toString().replace(/Rp/gi, "").replace(/\s/g, "").replace(/\./g, "").replace(/,/g, "");
    const num = Number(cleaned);
    return isNaN(num) ? null : num;
}

const sections = { STORE: [], ERO: [], PROMOTOR: [], FINANCING: [] };

/* ================= DATA FETCHING ================= */
fetch(CSV_URL)
.then(r => r.text())
.then(text => {
    const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
    let mode = "";

    lines.forEach(line => {
        const c = line.split("\t");
        const key = c[0]?.toUpperCase();

        if (sections.hasOwnProperty(key)) {
            mode = key;
            return;
        }

        if (!mode) return;

        let rawValue = (mode === "FINANCING") ? c[2] : c[3];
        const name = c[0]?.trim();
        const value = parseIDR(rawValue);

        if (!name || value === null || value === 0) return;
        const ignoreList = ["total", "target", "value", "achievement", "nama"];
        if (ignoreList.some(word => name.toLowerCase().includes(word))) return;

        sections[mode].push({ name, value });
    });

    renderSection("STORE", "#60a5fa"); 
    renderSection("ERO", "#4ade80");   
    renderSection("PROMOTOR", "#facc15"); 
    renderSection("FINANCING", "#c084fc");
});

/* ================= RENDER FUNCTION ================= */
function renderSection(type, colorHex) {
    const data = [...sections[type]];
    if (!data.length) return;

    const container = document.getElementById(type);
    
    // LOGIKA KHUSUS: Jika data hanya 1 (seperti STORE)
    if (data.length === 1) {
        container.innerHTML = `
            <h2 class="font-black text-2xl mb-6 tracking-tight" style="color: ${colorHex}">${type}</h2>
            <div class="bg-white/5 border border-white/10 p-8 rounded-2xl flex flex-col items-center text-center">
                <p class="text-slate-400 text-sm uppercase font-bold mb-2 tracking-widest">${data[0].name}</p>
                <p class="text-4xl md:text-5xl font-black" style="color: ${colorHex}">Rp ${data[0].value.toLocaleString("id-ID")}</p>
            </div>
        `;
        return; // Berhenti di sini, tidak menggambar chart
    }

    // LOGIKA UNTUK DATA BANYAK (ERO, PROMOTOR, FINANCING)
    data.sort((a, b) => b.value - a.value);
    const top = data[0];
    const low = data[data.length - 1];

    container.innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <h2 class="font-black text-2xl tracking-tight" style="color: ${colorHex}">${type}</h2>
            <span class="bg-white/10 px-3 py-1 rounded-lg text-xs font-mono uppercase">Ranked</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div class="bg-white/5 border border-white/10 p-5 rounded-2xl">
                <p class="text-slate-400 text-xs uppercase font-bold mb-1">Peringkat 1 üî•</p>
                <p class="text-xl font-bold truncate">${top.name}</p>
                <p class="text-2xl font-black mt-1" style="color: ${colorHex}">Rp ${top.value.toLocaleString("id-ID")}</p>
            </div>
            <div class="bg-white/5 border border-white/10 p-5 rounded-2xl">
                <p class="text-slate-400 text-xs uppercase font-bold mb-1">Peringkat Terakhir ‚ùÑÔ∏è</p>
                <p class="text-xl font-bold truncate">${low.name}</p>
                <p class="text-2xl font-black mt-1 text-slate-300">Rp ${low.value.toLocaleString("id-ID")}</p>
            </div>
        </div>

        <div class="relative h-[300px] w-full">
            <canvas id="${type}Chart"></canvas>
        </div>
    `;

    new Chart(document.getElementById(type + "Chart"), {
        type: "bar",
        data: {
            labels: data.map(d => d.name),
            datasets: [{
                data: data.map(d => d.value),
                backgroundColor: colorHex,
                borderRadius: 10,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: "rgba(255,255,255,0.05)" }, ticks: { color: "#94a3b8" } },
                y: { grid: { display: false }, ticks: { color: "#f8fafc" } }
            }
        }
    });
}
</script>
</body>
</html>